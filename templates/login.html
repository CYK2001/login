<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 - 项目管理平台</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-icons.css') }}">
    
    <!-- 工具函数将在页面底部的主脚本中导入 -->
</head>

<body class="login-page">
    <!-- 顶部通知栏 -->    
    <div id="top-notice" class="top-notice" style="display: none;">
        <span id="notice-message"></span>
    </div>
    
    <div class="login-container">
        <!-- 左侧欢迎区域 -->
        <div class="welcome-section">
            <div class="welcome-content">
                <h1>欢迎</h1>
                <p>感谢使用个人信息管理系统</p>
                <p>V1.0.0</p>
            </div>
            
            <!-- 3D 立方体动画 -->
            <div class="cube-container">
                <div class="cube">
                    <div class="face front"></div>
                    <div class="face back"></div>
                    <div class="face right"></div>
                    <div class="face left"></div>
                    <div class="face top"></div>
                    <div class="face bottom"></div>
                </div>
            </div>
        </div>
        
        <!-- 右侧登录区域 -->
        <div class="login-section">
            <!-- 显示消息 -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <script type="module">
                        // 从utils.js导入所需函数
                        import { showMessage } from '{{ url_for('static', filename='js/utils.js') }}';
                        
                        document.addEventListener('DOMContentLoaded', function() {
                            {% for category, message in messages %}
                                showMessage('{{ message | safe }}', '{{ category }}');
                            {% endfor %}
                        });
                    </script>
                {% endif %}
            {% endwith %}
            
            <!-- 显示错误消息 -->
            {% if error %}
                <script type="module">
                    // 从utils.js导入所需函数
                    import { showMessage } from '{{ url_for('static', filename='js/utils.js') }}';
                    
                    document.addEventListener('DOMContentLoaded', function() {
                        showMessage('{{ error | safe }}', 'error');
                        // 清空输入框数据
                        document.getElementById('username').value = '';
                        document.getElementById('password').value = '';
                        document.getElementById('captcha').value = '';
                        // 刷新验证码图片
                        document.getElementById('captcha-image').src = '/api/captcha?' + new Date().getTime();
                    });
                </script>
            {% endif %}
            
            <!-- 显示成功消息和自动跳转 -->
            {% if success %}
                <script type="module">
                    // 从utils.js导入所需函数
                    import { showMessage } from '{{ url_for('static', filename='js/utils.js') }}';
                    
                    // 立即执行跳转逻辑，不依赖DOMContentLoaded事件
                    showMessage('{{ success | safe }}', 'success');
                    
                    // 如果需要自动跳转
                    {% if auto_redirect and redirect_to %}
                    setTimeout(function() {
                        window.location.href = '{{ redirect_to }}';
                    }, 1500); // 1.5秒后跳转
                    {% endif %}
                </script>
            {% endif %}
            
            <div class="login-box">
                <!-- 登录标签 -->
                <div class="login-tabs">
                    <button class="tab-btn active">账号密码登录</button>
                </div>
                
                <!-- 登录表单 -->
                <form id="login-form">
                    <div class="form-group">
                        <input type="text" id="username" name="username" placeholder="请输入账号" required>
                    </div>
                    
                    <div class="form-group">
        <input type="password" id="password" name="password" placeholder="请输入密码" required>
        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('password')" aria-label="显示密码">
            <i class="bi bi-eye-slash"></i>
        </button>
    </div>
                    
                    <div class="form-group captcha">
                        <input type="text" id="captcha" name="captcha" placeholder="验证码" required>
                        <div class="captcha-image">
                            <img id="captcha-image" src="{{ url_for('generate_captcha_api') }}" alt="验证码">
                        </div>
                        <a href="#" class="refresh-captcha">刷新?</a>
                    </div>
                    
                    <button type="submit" class="login-btn">登录</button>
                </form>
                

            </div>
        </div>
    </div>
    
    <script type="module">
        // 引入通用工具库
        // 使用Flask模板语法生成静态文件URL
        import { apiCall, showMessage, validateForm, togglePasswordVisibility } from '{{ url_for('static', filename='js/utils.js') }}';
        
        // 将togglePasswordVisibility添加到全局作用域，以便按钮可以调用
        window.togglePasswordVisibility = togglePasswordVisibility;
        
        // 验证码刷新功能
        document.addEventListener('DOMContentLoaded', function() {
            const refreshCaptcha = document.querySelector('.refresh-captcha');
            const captchaImage = document.querySelector('.captcha-image img');
            
            if (refreshCaptcha && captchaImage) {
                refreshCaptcha.addEventListener('click', function(e) {
                    e.preventDefault();
                    // 刷新验证码图片
                    captchaImage.src = '{{ url_for('generate_captcha_api') }}?' + new Date().getTime();
                });
            }
            
            // 登录表单提交处理
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const captcha = document.getElementById('captcha').value;
                    
                    // 表单验证
                    const validationRules = {
                        username: { required: true, message: '用户名不能为空' },
                        password: { required: true, message: '密码不能为空' },
                        captcha: { required: true, message: '验证码不能为空' }
                    };
                    
                    if (!validateForm('login-form', validationRules, showMessage)) {
                        return;
                    }
                    
                    // 创建JSON数据
                    const jsonData = {
                        username: username,
                        password: password,
                        captcha: captcha
                    };
                    
                    // 使用通用API调用工具
                    // 硬编码API URL以避免双斜杠问题
                    apiCall('/api/login', 'POST', jsonData)
                    .then(result => {
                        // 检查响应结构
                        if (result && typeof result === 'object') {
                            
                            if (result.code === 200) {
                                // 登录成功，直接跳转到首页
                                
                                // 显示成功消息
                                showMessage('登录成功', 'success');
                                
                                // 添加延迟确保用户能看到成功提示后再跳转
                                setTimeout(() => {
                                    window.location.replace('/profile');
                                }, 1000);
                            } else {
                                showMessage(result.msg || '登录失败', 'error');
                                // 刷新验证码
                                captchaImage.src = '/api/captcha?' + new Date().getTime();
                            }
                        } else {
                            showMessage('登录失败，服务器响应格式错误', 'error');
                            // 刷新验证码
                            captchaImage.src = '/api/captcha?' + new Date().getTime();
                        }
                    })
                    .catch(error => {
                        showMessage(error.message || '登录失败', 'error');
                        // 刷新验证码
                        captchaImage.src = '/api/captcha?' + new Date().getTime();
                    });
                });
            }
            
            // 示例：页面加载后显示顶部通知
            // showTopNotice('欢迎使用登录系统');
        });
    </script>
</body>
</html>
