<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色管理 - 项目管理平台</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-icons.css') }}">
    
    <!-- 引入工具函数 -->
    <script type="module">
        // 从utils.js导入所需函数
        import { apiCall, showMessage, validateForm, showConfirm } from '{{ url_for('static', filename='js/utils.js') }}';
        
        // 将函数添加到全局作用域，以便页面中的其他脚本可以调用
        window.apiCall = apiCall;
        window.showMessage = showMessage;
        window.validateForm = validateForm;
        window.showConfirm = showConfirm;
        
        // 登出确认函数
        window.confirmLogout = async function(event) {
            // 阻止默认跳转行为
            event.preventDefault();
            
            // 显示确认对话框
            const result = await showConfirm('确定要登出吗？', 'warning');
            
            // 用户确认，执行登出操作
            if (result) {
                window.location.href = '{{ url_for('logout') }}';
            }
            // 用户取消，不执行任何操作
            return false;
        }
    </script>
</head>
<body class="profile-page">
    <!-- 顶部通知栏 -->    
    <div id="top-notice" class="top-notice" style="display: none;">
        <span id="notice-message"></span>
    </div>
    

    
    <div class="profile-container">
        <!-- 主布局：左侧导航栏 + 右侧内容区域 -->
        <div class="main-layout">
            <!-- 左侧导航栏 -->
            <nav class="side-nav">
                <div class="nav-header">
                    <h2>个人信息管理系统</h2>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="{{ url_for('profile_page') }}" class="nav-link">
                            <i class="bi bi-person"></i>
                            <span>个人信息管理</span>
                        </a>
                    </li>
                    {% if current_user_has_permission('用户管理') %}
                        <li class="nav-item">
                            <a href="{{ url_for('user_management_page') }}" class="nav-link">
                                <i class="bi bi-people"></i>
                                <span>用户管理</span>
                            </a>
                        </li>
                    {% endif %}
                    {% if current_user_has_permission('角色管理') %}
                        <li class="nav-item active">
                            <a href="{{ url_for('role_management_page') }}" class="nav-link">
                                <i class="bi bi-person-badge"></i>
                                <span>角色管理</span>
                            </a>
                        </li>
                    {% endif %}
                    {% if current_user_has_permission('审计日志管理') %}
                        <li class="nav-item">
                            <a href="{{ url_for('audit_logs_page') }}" class="nav-link">
                                <i class="bi bi-clock-history"></i>
                                <span>审计日志</span>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            
            <!-- 右侧内容区域 -->
            <main class="content-area">
                <!-- 页面标题 -->
                <div class="page-header">
                    <h1>角色管理</h1>
                    <div class="logout-container">
                        <a href="{{ url_for('logout') }}" class="btn logout-btn" onclick="return confirmLogout(event)">
                            <i class="bi bi-box-arrow-right"></i> 注销
                        </a>
                    </div>
                </div>
                
                <div class="profile-content">
            <!-- 角色列表 -->
            <section class="user-list-section">
                <h2>角色列表</h2>
                
                <!-- 查询模块 -->
                <div class="search-module">
                    <div class="search-inputs">
                        <div class="search-item">
                            <label for="role-name-search">角色：</label>
                        <input type="text" id="role-name-search" placeholder="请输入角色">
                        </div>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" id="search-btn">
                            <i class="bi bi-search"></i> 查询
                        </button>
                        <button class="btn btn-secondary" onclick="resetSearch()">
                            <i class="bi bi-arrow-clockwise"></i> 重置
                        </button>
                        <button class="btn btn-primary" onclick="showCreateRoleModal()">
                            <i class="bi bi-plus"></i> 新增角色
                        </button>
                        <div class="bulk-actions">
                            <button class="btn btn-danger" id="bulk-delete-btn" onclick="bulkDeleteRoles()" disabled>批量删除</button>
                        </div>
                    </div>
                </div>
                
                <!-- 角色列表 -->
                <div class="table-container">
                    <table class="modern-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()"></th>
                            <th>序号</th>
                            <th>角色</th>
                            <th>角色权限</th>
                            <th>权限数量</th>
                            <th>系统默认</th>
                            <th>使用状态</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                        <tbody id="role-table-body">
                            <!-- 角色数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控制 -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span>共 <span id="total-roles">0</span> 条记录</span>
                        <span>第 <span id="current-page">1</span>/<span id="total-pages">1</span> 页</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="btn btn-sm btn-outline-primary" onclick="goToPage(1)" id="first-page-btn" disabled>首页</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="goToPage(currentPage - 1)" id="prev-page-btn" disabled>
                            上一页
                        </button>
                        <div class="page-size-selector">
                            <label for="page-size-select">每页显示：</label>
                            <select id="page-size-select" onchange="changePageSize()">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="30">30</option>
                            </select>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="goToPage(currentPage + 1)" id="next-page-btn" disabled>
                            下一页
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="goToPage(totalPages)" id="last-page-btn" disabled>末页</button>
                        <div class="page-jump">
                            <label for="go-to-page-input">跳转到：</label>
                            <input type="number" id="go-to-page-input" min="1" value="1" onkeypress="handleGoToPageKeyPress(event)">
                            <button class="btn btn-sm btn-primary" onclick="jumpToPage()">跳转</button>
                        </div>
                    </div>
                </div>
            </section>
                </div>
            </main>
        </div>
    </div>
    
    <!-- 创建角色模态框 -->
    <div id="create-role-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>添加角色</h2>
                <button class="close-btn" onclick="closeModal('create-role-modal')" aria-label="关闭">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="create-role-form">
                    <div class="form-group">
                        <label for="create-role-name" class="form-label">
                            <span class="required">*</span>角色
                        </label>
                        <input type="text" id="create-role-name" name="name" placeholder="请输入角色" required class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="required">*</span>权限分配
                        </label>
                        <div id="create-permission-list" class="permission-list">
                            {% for permission in permissions %}
                                <div class="permission-item">
                                    <input type="checkbox" id="create-perm-{{ permission.id }}" name="permission_ids" value="{{ permission.permissions }}">
                                    <label for="create-perm-{{ permission.id }}">
                                        <span class="permission-name">{{ permission.permissions }}</span>
                                        <span class="permission-desc">{{ permission.description }}</span>
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('create-role-modal')">取消</button>
                <button type="submit" form="create-role-form" class="btn btn-primary">
                    <i class="bi bi-save"></i> 创建角色
                </button>
            </div>
        </div>
    </div>
    
    <!-- 编辑角色模态框 -->
    <div id="edit-role-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>编辑角色</h2>
                <button class="close-btn" onclick="closeModal('edit-role-modal')" aria-label="关闭">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-role-form">
                    <input type="hidden" id="edit-role-id" name="id">
                    <div class="form-group">
                        <label for="edit-role-name" class="form-label">
                            <span class="required">*</span>角色
                        </label>
                        <input type="text" id="edit-role-name" name="name" placeholder="请输入角色" required class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="required">*</span>权限分配
                        </label>
                        <div id="edit-permission-list" class="permission-list">
                    {% for permission in permissions %}
                        <div class="permission-item">
                            <input type="checkbox" id="edit-perm-{{ permission.id }}" name="permission_ids" value="{{ permission.permissions }}">
                            <label for="edit-perm-{{ permission.id }}">
                                <span class="permission-name">{{ permission.permissions }}</span>
                                <span class="permission-desc">{{ permission.description }}</span>
                            </label>
                        </div>
                    {% endfor %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('edit-role-modal')">取消</button>
                <button type="submit" form="edit-role-form" class="btn btn-primary">
                    <i class="bi bi-save"></i> 更新角色
                </button>
            </div>
        </div>
    </div>
    
    <!-- 角色管理功能脚本 -->
    <script>
        // 显示创建角色模态框
        function showCreateRoleModal() {
            document.getElementById('create-role-form').reset();
            document.getElementById('create-role-modal').style.display = 'flex';
        }
        
        // 显示编辑角色模态框
        function showEditRoleModal(roleId) {
            // 获取角色信息
            fetch(`/api/roles/${roleId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const role = data.data;
                        
                        // 填充表单数据
                        document.getElementById('edit-role-id').value = role.id;
                        document.getElementById('edit-role-name').value = role.role;
                        
                        // 填充权限数据
                        const permissions = role.permissions || [];
                        // 权限是字符串数组，直接使用
                        const checkboxes = document.querySelectorAll('#edit-permission-list input[type="checkbox"]');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = permissions.includes(checkbox.value);
                        });
                        
                        // 显示模态框
                        document.getElementById('edit-role-modal').style.display = 'flex';
                    } else {
                        showMessage(data.msg, 'error');
                    }
                })
                .catch(error => {
                    showMessage('获取角色信息失败', 'error');
                });
        }
        
        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // 创建角色表单提交处理
        document.getElementById('create-role-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 表单验证
            const validationRules = {
                name: { required: true, minLength: 2, maxLength: 20, message: '角色长度应在2-20个字符之间' }
            };
            
            if (!validateForm('create-role-form', validationRules, showMessage)) {
                return;
            }
            
            // 验证权限是否选择
            const permissionCheckboxes = document.querySelectorAll('#create-permission-list input[name="permission_ids"]:checked');
            if (permissionCheckboxes.length === 0) {
                showMessage('请至少选择一个权限', 'error');
                return;
            }
            
            // 创建表单数据
            const formData = new FormData(this);
            const jsonData = {};
            
            // 提取权限ID列表
            const permissionIds = Array.from(permissionCheckboxes).map(checkbox => checkbox.value);
            
            formData.forEach((value, key) => {
                jsonData[key] = value;
            });
            
            jsonData['permissions'] = permissionIds;
            
            // 发送创建角色请求
            fetch('/api/roles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 201) {
                    showMessage(data.msg, 'success');
                    closeModal('create-role-modal');
                    // 1秒后刷新页面
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showMessage(data.msg, 'error');
                }
            })
            .catch(error => {
                showMessage('创建角色失败', 'error');
            });
        });
        
        // 编辑角色表单提交处理
        document.getElementById('edit-role-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 表单验证
            const validationRules = {
                name: { required: true, minLength: 2, maxLength: 20, message: '角色长度应在2-20个字符之间' }
            };
            
            if (!validateForm('edit-role-form', validationRules, showMessage)) {
                return;
            }
            
            // 验证权限是否选择
            const permissionCheckboxes = document.querySelectorAll('#edit-permission-list input[name="permission_ids"]:checked');
            if (permissionCheckboxes.length === 0) {
                showMessage('请至少选择一个权限', 'error');
                return;
            }
            
            // 创建表单数据
            const formData = new FormData(this);
            const jsonData = {};
            
            // 提取权限ID列表
            const permissionIds = Array.from(permissionCheckboxes).map(checkbox => checkbox.value);
            
            formData.forEach((value, key) => {
                if (key === 'id') {
                    jsonData[key] = parseInt(value);
                } else {
                    jsonData[key] = value;
                }
            });
            
            jsonData['permissions'] = permissionIds;
            
            const roleId = document.getElementById('edit-role-id').value;
            
            // 发送更新角色请求
            fetch(`/api/roles/${roleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    showMessage(data.msg, 'success');
                    closeModal('edit-role-modal');
                    // 1秒后刷新页面
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showMessage(data.msg, 'error');
                }
            })
            .catch(error => {
                showMessage('更新角色失败', 'error');
            });
        });
        
        // 全局变量
        let currentPage = 1;
        let pageSize = 10;
        let totalRoles = 0;
        let totalPages = 1;
        let searchParams = {};
        let loadRolesTimeout = null;
        const DEBOUNCE_DELAY = 300; // 防抖延迟时间（毫秒）
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadRoles();
            
            // 搜索按钮点击事件
            document.getElementById('search-btn').addEventListener('click', function() {
                searchParams = {
                    name: document.getElementById('role-name-search').value.trim(),
                    page: 1,
                    page_size: pageSize
                };
                loadRoles();
            });
            
            // 移除窗口焦点事件监听器，避免点击输入框时自动发起请求
        });
        
        // 加载角色数据（添加防抖机制）
        async function loadRoles() {
            // 如果有未执行的请求，取消它
            if (loadRolesTimeout) {
                clearTimeout(loadRolesTimeout);
            }
            
            // 延迟执行请求，避免短时间内发起多次请求
            loadRolesTimeout = setTimeout(async () => {
                try {
                    const params = new URLSearchParams();
                    params.append('page', searchParams.page || currentPage);
                    params.append('page_size', searchParams.page_size || pageSize);
                    
                    if (searchParams.name) {
                        params.append('name', searchParams.name);
                    }
                    
                    const data = await apiCall(`/api/roles?${params.toString()}`, 'GET');
                    
                    if (data.code === 200) {
                        const roles = data.data.roles;
                        totalRoles = data.data.total;
                        totalPages = data.data.total_pages;
                        
                        // 检查当前页是否大于总页数，如果是则跳转到前一页
                        if ((searchParams.page || currentPage) > totalPages && totalPages > 0) {
                            searchParams.page = totalPages;
                            currentPage = totalPages;
                            loadRoles();
                            return;
                        }
                        
                        // 更新表格数据
                        updateRoleTable(roles);
                        
                        // 更新分页信息
                        updatePaginationInfo();
                        
                        // 更新分页按钮状态
                        updatePaginationButtons();
                        
                        // 更新批量操作按钮状态（保留选中状态）
                        updateBulkActionButtons();
                    } else {
                        showMessage(data.msg, 'error');
                    }
                } catch (error) {
                    showMessage('加载角色数据失败', 'error');
                }
            }, DEBOUNCE_DELAY);
        }
        
        // 更新角色表格
        function updateRoleTable(roles) {
            const tbody = document.getElementById('role-table-body');
            tbody.innerHTML = '';
            
            if (roles.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">暂无角色数据</td></tr>';
                    // 重置全选按钮状态
                    document.getElementById('select-all-checkbox').checked = false;
                    // 更新批量操作按钮状态
                    updateBulkActionButtons();
                    return;
                }
            
            roles.forEach((role, index) => {
                // 计算顺序号（1、2、3...）
                const currentPage = searchParams.page || 1;
                const currentPageSize = searchParams.page_size || pageSize;
                const sequentialNumber = (currentPage - 1) * currentPageSize + index + 1;
                
                const tr = document.createElement('tr');
                // 格式化权限显示
                const permissionsText = role.permissions && role.permissions.length > 0 
                    ? role.permissions.join(', ') 
                    : '--';
                
                // 检查是否为系统默认角色
                const isSystemDefault = role.role === '管理员' || role.role === '普通用户';
                // 获取使用状态，后端返回1表示正在使用，0表示未使用
                const isInUse = role.is_in_use || 0;
                
                // 为删除按钮添加tooltip
                let deleteButton = '';
                let tooltip = '';
                if (isSystemDefault) {
                    deleteButton = '<button class="btn btn-sm btn-danger" disabled title="系统默认角色不允许删除"><i class="bi bi-trash"></i> 删除</button>';
                } else {
                    deleteButton = `<button class="btn btn-sm btn-danger" onclick="deleteRole(${role.id})" ${isInUse ? 'title="该角色正在被使用，无法删除"' : ''}><i class="bi bi-trash"></i> 删除</button>`;
                }
                
                tr.innerHTML = `
                    <td><input type="checkbox" class="role-checkbox" value="${role.id}" onchange="updateBulkActionButtons()"></td>
                    <td>${sequentialNumber}</td>
                    <td>${role.role}</td>
                    <td>${permissionsText}</td>
                    <td>${role.permissions ? role.permissions.length : 0}</td>
                    <td>${isSystemDefault ? '<span class="badge bg-danger">是</span>' : '<span class="badge bg-success">否</span>'}</td>
                    <td><span class="status-indicator"><span class="status-dot ${isInUse ? 'used' : 'unused'}"></span>${isInUse ? '正在使用' : '未使用'}</span></td>
                    <td>${role.created_at ? new Date(role.created_at).toLocaleString('zh-CN') : '--'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditRoleModal(${role.id})"><i class="bi bi-pencil"></i> 编辑</button>
                        ${deleteButton}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // 重置全选按钮状态
            document.getElementById('select-all-checkbox').checked = false;
            
            // 更新批量操作按钮状态
            updateBulkActionButtons();
        }
        
        // 更新分页信息
        function updatePaginationInfo() {
            document.getElementById('total-roles').textContent = totalRoles;
            document.getElementById('current-page').textContent = searchParams.page || currentPage;
            document.getElementById('total-pages').textContent = totalPages;
            document.getElementById('go-to-page-input').value = searchParams.page || currentPage;
        }
        
        // 更新批量操作按钮状态
        function updateBulkActionButtons() {
            const roleCheckboxes = document.querySelectorAll('.role-checkbox:checked');
            const hasSelected = roleCheckboxes.length > 0;
            
            // 检查是否包含系统默认角色
            let containsSystemRole = false;
            if (hasSelected) {
                for (const checkbox of roleCheckboxes) {
                    const row = checkbox.closest('tr');
                    const roleName = row.querySelector('td:nth-child(3)').textContent;
                    if (roleName === '管理员' || roleName === '普通用户') {
                        containsSystemRole = true;
                        break;
                    }
                }
            }
            
            // 如果有选中的系统默认角色，则禁用批量删除按钮
            document.getElementById('bulk-delete-btn').disabled = !hasSelected || containsSystemRole;
        }
        
        // 更新分页按钮状态
        function updatePaginationButtons() {
            const currentPageNum = searchParams.page || currentPage;
            
            document.getElementById('first-page-btn').disabled = currentPageNum === 1;
            document.getElementById('prev-page-btn').disabled = currentPageNum === 1;
            document.getElementById('next-page-btn').disabled = currentPageNum === totalPages;
            document.getElementById('last-page-btn').disabled = currentPageNum === totalPages;
        }
        
        // 跳转到指定页码
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            
            searchParams.page = page;
            currentPage = page;
            loadRoles();
        }
        
        // 改变每页显示数量
        function changePageSize() {
            pageSize = parseInt(document.getElementById('page-size-select').value);
            searchParams.page_size = pageSize;
            searchParams.page = 1;
            currentPage = 1;
            loadRoles();
        }
        
        // 处理跳转到指定页码的键盘事件
        function handleGoToPageKeyPress(event) {
            if (event.key === 'Enter') {
                jumpToPage();
            }
        }
        
        // 跳转到指定页
        function jumpToPage() {
            const pageInput = document.getElementById('go-to-page-input');
            let pageNum = parseInt(pageInput.value);
            
            // 自动处理无效页码
            if (isNaN(pageNum) || pageNum < 1) {
                pageNum = 1;
            } else if (pageNum > totalPages) {
                pageNum = totalPages;
            }
            
            // 更新输入框显示的页码
            pageInput.value = pageNum;
            
            // 执行跳转
            goToPage(pageNum);
        }
        
        // 重置搜索
        function resetSearch() {
            document.getElementById('role-name-search').value = '';
            searchParams = {};
            currentPage = 1;
            loadRoles();
        }
        
        // 全选/取消全选 - 可以选择默认角色
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const roleCheckboxes = document.querySelectorAll('.role-checkbox');
            
            if (selectAllCheckbox.checked) {
                // 全选所有角色，包括默认角色
                roleCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
            } else {
                // 取消全选
                roleCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            
            // 更新批量操作按钮状态
            updateBulkActionButtons();
        }
        
        // 单个角色选择 - 与用户管理页面保持一致
        function toggleRoleSelection(roleId, isSelected) {
            // 更新全选复选框状态
            updateSelectAllCheckbox();
            
            // 更新批量操作按钮状态
            updateBulkActionButtons();
        }
        
        // 更新全选复选框状态
        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const roleCheckboxes = document.querySelectorAll('.role-checkbox');
            
            if (roleCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }
            
            // 计算可选择的角色数量（排除系统默认角色）
            let totalSelectable = 0;
            let checkedCount = 0;
            
            roleCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const roleName = row.querySelector('td:nth-child(3)').textContent;
                if (roleName !== '管理员' && roleName !== '普通用户') {
                    totalSelectable++;
                    if (checkbox.checked) {
                        checkedCount++;
                    }
                }
            });
            
            if (checkedCount === totalSelectable && totalSelectable > 0) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }
        

        
        // 批量删除角色
        async function bulkDeleteRoles() {
            const roleCheckboxes = document.querySelectorAll('.role-checkbox:checked');
            const roleIds = Array.from(roleCheckboxes).map(checkbox => parseInt(checkbox.value));
            
            if (roleIds.length === 0) {
                showMessage('请先选择要删除的角色', 'warning');
                return;
            }
            
            // 确认删除
            const confirmed = await showConfirm('确定要删除选中的角色吗？此操作不可恢复。');
            if (!confirmed) return;
            
            try {
                // 发送批量删除请求
                const response = await fetch('/api/roles/bulk-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role_ids: roleIds })
                });
                const data = await response.json();
                
                if (data.code === 200) {
                    showMessage(data.msg, 'success');
                    // 清除选择状态
                    document.querySelectorAll('.role-checkbox:checked').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    // 重置全选按钮状态
                    document.getElementById('select-all-checkbox').checked = false;

                    // 重新加载角色列表
                    loadRoles();
                } else {
                    // 提供更详细的错误信息
                    let errorMsg = data.msg;
                    if (data.msg.includes('系统默认角色')) {
                        errorMsg = '系统默认角色（管理员、普通用户）不允许批量删除';
                    } else if (data.msg.includes('正在被使用')) {
                        errorMsg = '选中的部分角色正在被使用，无法删除';
                    }
                    showMessage(errorMsg, 'error');
                }
            } catch (error) {
                showMessage('批量删除角色失败，请检查网络连接或联系管理员', 'error');
            }
        }
        
        // 删除角色
        async function deleteRole(roleId) {
            // 获取当前行的角色信息
            const row = document.querySelector(`.role-checkbox[value="${roleId}"]`).closest('tr');
            const roleName = row.querySelector('td:nth-child(3)').textContent;
            
            const confirmed = await showConfirm('确定要删除该角色吗？此操作不可恢复。', 'warning');
            if (!confirmed) return;
            
            try {
                const data = await apiCall(`/api/roles/${roleId}`, 'DELETE');
                showMessage(data.msg, 'success');
                
                // 重新加载角色数据
                loadRoles();
            } catch (error) {
                // 提供更详细的错误信息
                let errorMsg = '删除角色失败';
                if (error.message && error.message.includes('系统默认角色')) {
                    errorMsg = '系统默认角色不允许删除';
                } else if (error.message && error.message.includes('正在被使用')) {
                    errorMsg = '该角色正在被使用，无法删除';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                showMessage(errorMsg, 'error');
            }
        }
        
        // 点击模态框外部关闭模态框
        window.addEventListener('click', function(e) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>