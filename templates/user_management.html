<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - 项目管理平台</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-icons.css') }}">
    
    <!-- 引入工具函数 -->
    <script type="module">
        // 从utils.js导入所需函数
        import { apiCall, showMessage, validateForm, showConfirm, togglePasswordVisibility } from '{{ url_for('static', filename='js/utils.js') }}';
        
        // 将函数添加到全局作用域，以便页面中的其他脚本可以调用
        window.apiCall = apiCall;
        window.showMessage = showMessage;
        window.validateForm = validateForm;
        window.showConfirm = showConfirm;
        window.togglePasswordVisibility = togglePasswordVisibility;
        
        // 登出确认函数
        window.confirmLogout = async function(event) {
            // 阻止默认跳转行为
            event.preventDefault();
            
            // 显示确认对话框
            const result = await showConfirm('确定要登出吗？', 'warning');
            
            // 用户确认，执行登出操作
            if (result) {
                window.location.href = '{{ url_for('logout') }}';
            }
            // 用户取消，不执行任何操作
            return false;
        }
    </script>
</head>
<body class="profile-page">
    <!-- 顶部通知栏 -->    
    <div id="top-notice" class="top-notice" style="display: none;">
        <span id="notice-message"></span>
    </div>
    

    
    <div class="profile-container">
        <!-- 主布局：左侧导航栏 + 右侧内容区域 -->
        <div class="main-layout">
            <!-- 左侧导航栏 -->
            <nav class="side-nav">
                <div class="nav-header">
                    <h2>个人信息管理系统</h2>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="{{ url_for('profile_page') }}" class="nav-link">
                            <i class="bi bi-person"></i>
                            <span>个人信息管理</span>
                        </a>
                    </li>
                    {% if current_user_has_permission('用户管理') %}
                        <li class="nav-item active">
                            <a href="{{ url_for('user_management_page') }}" class="nav-link">
                                <i class="bi bi-people"></i>
                                <span>用户管理</span>
                            </a>
                        </li>
                    {% endif %}
                    {% if current_user_has_permission('角色管理') %}
                        <li class="nav-item">
                            <a href="{{ url_for('role_management_page') }}" class="nav-link">
                                <i class="bi bi-person-badge"></i>
                                <span>角色管理</span>
                            </a>
                        </li>
                    {% endif %}
                    {% if current_user_has_permission('审计日志管理') %}
                        <li class="nav-item">
                            <a href="{{ url_for('audit_logs_page') }}" class="nav-link">
                                <i class="bi bi-clock-history"></i>
                                <span>审计日志</span>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            
            <!-- 右侧内容区域 -->
            <main class="content-area">
                <!-- 页面标题 -->
                <div class="page-header">
                    <h1>用户管理</h1>
                    <div class="logout-container">
                        <a href="{{ url_for('logout') }}" class="btn logout-btn" onclick="return confirmLogout(event)">
                            <i class="bi bi-box-arrow-right"></i> 注销
                        </a>
                    </div>
                </div>
                
                <div class="profile-content">
            <!-- 用户列表 -->
            <section class="user-list-section">
                <h2>用户列表</h2>
                
                <!-- 查询模块 -->
                <div class="search-module">
                    <div class="search-inputs">
                        <div class="search-item">
                            <label for="name-search">姓名：</label>
                            <input type="text" id="name-search" placeholder="请输入姓名">
                        </div>
                        <div class="search-item">
                            <label for="username-search">用户名：</label>
                            <input type="text" id="username-search" placeholder="请输入用户名">
                        </div>
                        <div class="search-item">
                            <label for="role-search">角色：</label>
                            <select id="role-search" class="form-select search-select">
                                <option value="">全部角色</option>
                                <option value="admin">管理员</option>
                                <option value="user">普通用户</option>
                            </select>
                        </div>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" id="search-btn">
                            <i class="bi bi-search"></i> 查询
                        </button>
                        <button class="btn btn-secondary" onclick="resetSearch()">
                            <i class="bi bi-arrow-clockwise"></i> 重置
                        </button>
                        <button class="btn btn-primary" onclick="showCreateUserModal()">
                            <i class="bi bi-plus"></i> 新增用户
                        </button>
                        <div class="bulk-actions">
                            <button class="btn btn-danger" onclick="bulkDeleteUsers()" id="bulk-delete-btn" disabled>批量删除</button>
                            <button class="btn btn-warning" onclick="bulkResetPasswords()" id="bulk-reset-btn" disabled>批量重置密码</button>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()"></th>
                                <th>序号</th>
                                <th>用户名</th>
                                <th>姓名</th>
                                <th>邮箱</th>
                                <th>手机号</th>
                                <th>性别</th>
                                <th>创建时间</th>
                                <th>角色</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <!-- 用户数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控制 -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span>共 <span id="total-users">0</span> 条记录</span>
                        <span>第 <span id="current-page">1</span>/<span id="total-pages">1</span> 页</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="btn btn-sm btn-outline-primary" onclick="goToPage(1)" id="first-page-btn" disabled>首页</button>
                <button class="btn btn-sm btn-outline-primary" onclick="goToPage(window.currentPage - 1)" id="prev-page-btn" disabled>
                    上一页
                </button>
                        <div class="page-size-selector">
                            <label for="page-size">每页显示：</label>
                            <select id="page-size" onchange="changePageSize()">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="30">30</option>
                            </select>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="goToPage(window.currentPage + 1)" id="next-page-btn" disabled>
                    下一页
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="goToPage(window.totalPages)" id="last-page-btn" disabled>末页</button>
                        <div class="page-jump">
                            <label for="page-input">跳转到：</label>
                              <input type="number" id="page-input" min="1" value="1" onkeypress="if(event.keyCode === 13) jumpToPage()">
                            <button class="btn btn-sm btn-primary" onclick="jumpToPage()">跳转</button>
                        </div>
                    </div>
                </div>
            </section>
                </div>
            </main>
        </div>
    </div>
    
    <!-- 创建用户模态框 -->
    <div id="create-user-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>添加用户</h2>
                <button class="close-btn" onclick="closeModal('create-user-modal')" aria-label="关闭">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="create-user-form">
                    <div class="form-group">
                        <label for="create-role" class="form-label">
                            <span class="required">*</span>角色
                        </label>
                        <select id="create-role" name="role" class="form-select" required>
                            <option value="">请选择角色</option>
                            <option value="普通用户">普通用户</option>
                            <option value="管理员">管理员</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="create-username" class="form-label">
                            <span class="required">*</span>用户名
                        </label>
                        <input type="text" id="create-username" name="username" placeholder="请输入用户名" required class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="create-password" class="form-label">
                            <span class="required">*</span>密码
                        </label>
                        <div class="password-input-group">
                            <input type="password" id="create-password" name="password" placeholder="请输入密码" required class="form-input">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('create-password')" aria-label="显示密码">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="create-name" class="form-label">姓名</label>
                        <input type="text" id="create-name" name="name" placeholder="请输入姓名" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="create-email" class="form-label">邮箱</label>
                        <input type="email" id="create-email" name="email" placeholder="请输入邮箱" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="create-phone" class="form-label">手机号</label>
                        <input type="tel" id="create-phone" name="phone" placeholder="请输入手机号" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="create-gender" class="form-label">性别</label>
                        <select id="create-gender" name="gender" class="form-select">
                            <option value="">请选择</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('create-user-modal')">取消</button>
                <button type="submit" form="create-user-form" class="btn btn-primary">
                    <i class="bi bi-save"></i> 创建用户
                </button>
            </div>
        </div>
    </div>
    
    <!-- 编辑用户模态框 -->
    <div id="edit-user-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>编辑用户</h2>
                <button class="close-btn" onclick="closeModal('edit-user-modal')" aria-label="关闭">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id" name="id">
                    <div class="form-group">
                        <label for="edit-username" class="form-label">用户名</label>
                        <input type="text" id="edit-username" name="username" readonly class="form-input" style="background-color: #f5f5f5; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label for="edit-role" class="form-label">
                            <span class="required">*</span>角色
                        </label>
                        <select id="edit-role" name="role" class="form-select" required>
                            <option value="普通用户">普通用户</option>
                            <option value="管理员">管理员</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-name" class="form-label">姓名</label>
                        <input type="text" id="edit-name" name="name" placeholder="请输入姓名" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="edit-email" class="form-label">邮箱</label>
                        <input type="email" id="edit-email" name="email" placeholder="请输入邮箱" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="edit-phone" class="form-label">手机号</label>
                        <input type="tel" id="edit-phone" name="phone" placeholder="请输入手机号" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="edit-gender" class="form-label">性别</label>
                        <select id="edit-gender" name="gender" class="form-select">
                            <option value="">请选择</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('edit-user-modal')">取消</button>
                <button type="submit" form="edit-user-form" class="btn btn-primary">
                    <i class="bi bi-save"></i> 更新用户
                </button>
            </div>
        </div>
    </div>
    
    <!-- 重置密码模态框 (已废弃，改为直接确认重置) -->
    <div id="reset-password-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>重置密码</h2>
                <button class="close-btn" onclick="closeModal('reset-password-modal')" aria-label="关闭">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="reset-password-form">
                    <input type="hidden" id="reset-user-id" name="id">
                    <div class="form-group">
                        <label for="reset-new-password" class="form-label">
                            <span class="required">*</span>新密码
                        </label>
                        <div class="password-input-group">
                            <input type="password" id="reset-new-password" name="new_password" placeholder="请输入新密码" required class="form-input">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('reset-new-password')" aria-label="显示密码">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reset-confirm-password" class="form-label">
                            <span class="required">*</span>确认新密码
                        </label>
                        <div class="password-input-group">
                            <input type="password" id="reset-confirm-password" name="confirm_password" placeholder="请再次输入新密码" required class="form-input">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('reset-confirm-password')" aria-label="显示密码">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('reset-password-modal')">取消</button>
                <button type="submit" form="reset-password-form" class="btn btn-primary">
                    <i class="bi bi-key"></i> 重置密码
                </button>
            </div>
        </div>
    </div>
    
    <!-- 密码可见性切换功能 -->
    <script>
        // 全局错误处理
        window.addEventListener('error', function(e) {
            alert('JavaScript错误: ' + e.error.message + '\n在第' + e.lineno + '行');
        });
        
        // Promise错误处理
        window.addEventListener('unhandledrejection', function(e) {
            alert('Promise错误: ' + e.reason.message);
        });
        
        // 确保所有关键函数在全局作用域中可用
        window.searchParams = {};
        window.currentPage = 1;
        window.pageSize = 10;
        window.totalUsers = 0;
        window.totalPages = 1;
        
        // 密码可见性切换函数
        // 使用utils.js中的togglePasswordVisibility函数
        
        // 显示创建用户模态框
        function showCreateUserModal() {
            document.getElementById('create-user-form').reset();
            document.getElementById('create-user-modal').style.display = 'flex';
        }
        
        // 显示编辑用户模态框
        function showEditUserModal(userId) {
            // 获取用户信息
            fetch(`/api/users/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const user = data.data.user;
                        
                        // 填充表单数据
                        document.getElementById('edit-user-id').value = user.id;
                        document.getElementById('edit-username').value = user.username;
                        document.getElementById('edit-name').value = user.name || '';
                        document.getElementById('edit-email').value = user.email || '';
                        document.getElementById('edit-phone').value = user.phone || '';
                        document.getElementById('edit-gender').value = user.gender || '';
                        
                        // 设置角色选择
                        document.getElementById('edit-role').value = user.role || '普通用户';
                        
                        // 显示模态框
                        document.getElementById('edit-user-modal').style.display = 'flex';
                    } else {
                        showMessage(data.msg, 'error');
                    }
                })
                .catch(error => {
                            showMessage('获取用户信息失败', 'error');
                        });
        }
        
        // 显示重置密码确认提示
async function showResetPasswordModal(userId) {
    const confirmed = await showConfirm(`确定要重置该用户的密码吗？`, 'warning');
    if (!confirmed) return;
    
    try {
        const data = await apiCall(`/api/users/${userId}/reset-password`, 'POST', { new_password: 'test123' });
        showMessage(data.msg || '密码重置成功', 'success');
        
        // 如果响应消息包含需要重新登录的提示，跳转到登录页面
        if (data.msg && data.msg.includes('需要重新登录')) {
            setTimeout(() => {
                window.location.href = '/login';
            }, 1000);
        } else {
            // 立即刷新用户列表
            loadUsers();
        }
    } catch (error) {
        showMessage(error.message || '密码重置失败', 'error');
    }
}
        
        // 关闭模态框 (保留以兼容其他功能)
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // 创建用户表单提交处理
        document.getElementById('create-user-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 表单验证
            const validationRules = {
                role: { required: true, message: '请选择用户角色' },
                username: { required: true, minLength: 3, maxLength: 20, message: '用户名长度应在3-20个字符之间' },
                password: { required: true, minLength: 6, maxLength: 20, message: '密码长度应在6-20个字符之间' }
            };
            
            if (!validateForm('create-user-form', validationRules, showMessage)) {
                return;
            }
            
            // 创建表单数据
            const formData = new FormData(this);
            const jsonData = {};
            formData.forEach((value, key) => {
                jsonData[key] = value;
            });
            
            // 发送创建用户请求
            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 201) {
                    showMessage(data.msg, 'success');
                    closeModal('create-user-modal');
                    // 1秒后重新加载用户数据
        setTimeout(() => {
            loadUsers();
        }, 1000);
                } else {
                    showMessage(data.msg, 'error');
                }
            })
            .catch(error => {
                    showMessage('创建用户失败', 'error');
                });
        });
        
        // 编辑用户表单提交处理
        document.getElementById('edit-user-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 表单验证
            const validationRules = {
                role: { required: true, message: '请选择用户角色' }
            };
            
            if (!validateForm('edit-user-form', validationRules, showMessage)) {
                return;
            }
            
            // 创建表单数据
            const formData = new FormData(this);
            const jsonData = {};
            formData.forEach((value, key) => {
                jsonData[key] = value;
            });
            
            const userId = document.getElementById('edit-user-id').value;
            
            // 发送更新用户请求
            fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    showMessage(data.msg, 'success');
                    closeModal('edit-user-modal');
                    // 1秒后重新加载用户数据
        setTimeout(() => {
            loadUsers();
        }, 1000);
                } else {
                    showMessage(data.msg, 'error');
                }
            })
            .catch(error => {
                    showMessage('更新用户失败', 'error');
                });
        });
        
        // 重置密码表单提交处理 (已废弃，改为直接调用API)
        document.getElementById('reset-password-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 表单验证
            const validationRules = {
                new_password: { required: true, minLength: 6, maxLength: 20, message: '密码长度应在6-20个字符之间' },
                confirm_password: { required: true, equalTo: 'reset-new-password', message: '两次输入的密码不一致' }
            };
            
            if (!validateForm('reset-password-form', validationRules, showMessage)) {
                return;
            }
            
            const userId = document.getElementById('reset-user-id').value;
            const newPassword = document.getElementById('reset-new-password').value;
            
            // 发送重置密码请求
            fetch(`/api/users/${userId}/reset-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ new_password: newPassword })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    showMessage(data.msg, 'success');
                    closeModal('reset-password-modal');
                } else {
                    showMessage(data.msg, 'error');
                }
            })
            .catch(error => {
                showMessage('重置密码失败', 'error');
            });
        });
        
        // 删除用户
        async function deleteUser(userId) {
            const confirmed = await showConfirm('确定要删除该用户吗？此操作不可恢复。', 'warning');
            if (!confirmed) return;
            
            try {
                const data = await apiCall(`/api/users/${userId}`, 'DELETE');
                showMessage(data.msg, 'success');
                // 立即重新加载用户列表
                loadUsers();
            } catch (error) {
                showMessage(error.message || '删除用户失败', 'error');
            }
        }
        
        // 点击模态框外部关闭模态框
        window.addEventListener('click', function(e) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
        
        // 分页相关变量
        window.currentPage = 1;
        window.pageSize = 10;
        window.totalUsers = 0;
        window.totalPages = 1;
        window.searchParams = {};
        
        // 加载角色列表 - 获取所有角色用于下拉框
        async function loadRoles() {
            try {
                // 获取所有角色（不分页）
                const data = await apiCall('/api/roles?page=1&page_size=1000', 'GET');
                if (data.code === 200) {
                    const roles = data.data.roles;
                    
                    // 填充创建用户下拉框
                    const createRoleSelect = document.getElementById('create-role');
                    createRoleSelect.innerHTML = '<option value="">请选择角色</option>';
                    roles.forEach(role => {
                        createRoleSelect.innerHTML += `<option value="${role.role}">${role.role}</option>`;
                    });
                    
                    // 填充编辑用户下拉框
                    const editRoleSelect = document.getElementById('edit-role');
                    editRoleSelect.innerHTML = '<option value="">请选择角色</option>';
                    roles.forEach(role => {
                        editRoleSelect.innerHTML += `<option value="${role.role}">${role.role}</option>`;
                    });
                    
                    // 填充搜索角色下拉框
                    const searchRoleSelect = document.getElementById('role-search');
                    searchRoleSelect.innerHTML = '<option value="">所有角色</option>';
                    roles.forEach(role => {
                        searchRoleSelect.innerHTML += `<option value="${role.role}">${role.role}</option>`;
                    });
                }
            } catch (error) {
                // 静默处理
            }
        }
        
        // 页面加载完成后初始化数据
        document.addEventListener('DOMContentLoaded', function() {
            // 加载用户数据
            loadUsers();
            
            // 加载角色列表
            loadRoles();
            
            // 为搜索按钮添加点击事件
            const searchBtn = document.getElementById('search-btn');
            if (searchBtn) {
                searchBtn.addEventListener('click', searchUsers);
            }
        });
        
        // 加载用户数据
        function loadUsers() {
            // 构建查询参数
            const params = new URLSearchParams();
            params.append('page', window.currentPage);
            params.append('page_size', window.pageSize);
            
            // 添加搜索条件
            if (window.searchParams.username) {
                params.append('username', window.searchParams.username);
            }
            if (window.searchParams.name) {
                params.append('name', window.searchParams.name);
            }
            if (window.searchParams.role) {
                params.append('role', window.searchParams.role);
            }
            
            // 发送请求
            const url = `/api/users?${params.toString()}`;
            
            fetch(url)
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    if (data.code === 200) {
                        const users = data.data.users;
                        window.totalUsers = data.data.total;
                        window.totalPages = data.data.total_pages;
                        
                        // 检查当前页是否大于总页数，如果是则跳转到前一页
                        if (window.currentPage > window.totalPages && window.totalPages > 0) {
                            window.currentPage = window.totalPages;
                            // 重新加载数据
                            loadUsers();
                            return;
                        }
                        
                        // 更新分页信息
                        updatePaginationInfo();
                        
                        // 渲染用户列表
                        renderUsers(users);
                        
                        // 更新分页按钮状态
                        updatePaginationButtons();
                    } else {
                        showMessage(data.msg, 'error');
                    }
                })
                .catch(error => {
                    showMessage('获取用户列表失败', 'error');
                });
        }
        
        // 渲染用户列表
        function renderUsers(users) {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">暂无数据</td></tr>';
                // 重置全选按钮状态
                document.getElementById('select-all-checkbox').checked = false;
                // 更新批量操作按钮状态
                updateBulkActionButtons();
                return;
            }
            
            users.forEach((user, index) => {
                // 计算顺序ID：(当前页码-1)*每页显示数量 + 当前项在当前页的索引 + 1
                const sequentialId = (window.currentPage - 1) * window.pageSize + index + 1;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="user-checkbox" value="${user.id}" onchange="updateBulkActionButtons()"></td>
                    <td>${sequentialId}</td>
                    <td>${user.username || '--'}</td>
                    <td>${user.name || '--'}</td>
                    <td>${user.email || '--'}</td>
                    <td>${user.phone || '--'}</td>
                    <td>${user.gender || '--'}</td>
                    <td>${user.created_at ? new Date(user.created_at).toLocaleString('zh-CN') : '--'}</td>
                    <td>
                            <span class="role-badge">${user.role || '--'}</span>
                        </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditUserModal(${user.id})"><i class="bi bi-pencil"></i> 编辑</button>
                        <button class="btn btn-sm btn-warning" onclick="showResetPasswordModal(${user.id})"><i class="bi bi-key"></i> 重置密码</button>
                        ${user.role === '管理员' ? '<button class="btn btn-sm btn-danger" disabled><i class="bi bi-trash"></i> 删除</button>' : '<button class="btn btn-sm btn-danger" onclick="deleteUser(' + user.id + ')"><i class="bi bi-trash"></i> 删除</button>'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // 重置全选按钮状态
            document.getElementById('select-all-checkbox').checked = false;
            // 更新批量操作按钮状态
            updateBulkActionButtons();
        }
        
        // 更新分页信息
        function updatePaginationInfo() {
            document.getElementById('total-users').textContent = window.totalUsers;
            document.getElementById('current-page').textContent = window.currentPage;
            document.getElementById('total-pages').textContent = window.totalPages;
            document.getElementById('page-input').value = window.currentPage;
        }
        
        // 更新分页按钮状态
        function updatePaginationButtons() {
            document.getElementById('prev-page-btn').disabled = window.currentPage <= 1;
            document.getElementById('next-page-btn').disabled = window.currentPage >= window.totalPages;
            // 首页按钮：当前页为1时置灰
            document.getElementById('first-page-btn').disabled = window.currentPage <= 1;
            // 末页按钮：当前页为最后一页时置灰
            document.getElementById('last-page-btn').disabled = window.currentPage >= window.totalPages;
        }
        
        // 跳转到指定页面
        function goToPage(page) {
            if (page < 1 || page > window.totalPages) {
                return;
            }
            
            window.currentPage = page;
            loadUsers();
        }
        
        // 全选/取消全选
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateBulkActionButtons();
        }
        
        // 更新批量操作按钮状态
        function updateBulkActionButtons() {
            const userCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const hasSelected = userCheckboxes.length > 0;
            
            // 检查是否包含admin用户
            let containsAdmin = false;
            if (hasSelected) {
                for (const checkbox of userCheckboxes) {
                    const row = checkbox.closest('tr');
                    const roleBadge = row.querySelector('.role-badge');
                    if (roleBadge && roleBadge.textContent.trim() === '管理员') {
                        containsAdmin = true;
                        break;
                    }
                }
            }
            
            // 如果有选中的admin用户，则禁用批量删除按钮
            document.getElementById('bulk-delete-btn').disabled = !hasSelected || containsAdmin;
            // 重置密码按钮不受admin用户影响
            document.getElementById('bulk-reset-btn').disabled = !hasSelected;
        }
        
        // 批量删除用户
        async function bulkDeleteUsers() {
            const userCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const selectedIds = Array.from(userCheckboxes).map(checkbox => parseInt(checkbox.value));
            
            if (selectedIds.length === 0) {
                showMessage('请先选择要删除的用户', 'warning');
                return;
            }
            
            // 检查是否包含admin用户
            const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            for (const checkbox of selectedCheckboxes) {
                const row = checkbox.closest('tr');
                const roleBadge = row.querySelector('.role-badge');
                if (roleBadge && roleBadge.textContent.trim() === '管理员') {
                    showMessage('admin账户不允许删除', 'warning');
                    return;
                }
            }
            
            const confirmed = await showConfirm(`确定要删除选中的 ${selectedIds.length} 个用户吗？此操作不可恢复。`, 'warning');
            if (!confirmed) return;
            
            try {
                const data = await apiCall('/api/users/bulk-delete', 'POST', { user_ids: selectedIds });
                showMessage(data.msg || `成功删除 ${data.deleted_count} 个用户`, 'success');
                
                // 清除选择状态
                document.querySelectorAll('.user-checkbox:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });
                // 重置全选按钮状态
                document.getElementById('select-all-checkbox').checked = false;
                // 更新批量操作按钮状态
                updateBulkActionButtons();
                
                // 立即重新加载用户列表
                loadUsers();
            } catch (error) {
                showMessage(error.message || '删除用户失败', 'error');
            }
        }
        
        // 批量重置密码
        async function bulkResetPasswords() {
            const userCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const selectedIds = Array.from(userCheckboxes).map(checkbox => parseInt(checkbox.value));
            
            if (selectedIds.length === 0) {
                showMessage('请先选择要重置密码的用户', 'warning');
                return;
            }
            
            const confirmed = await showConfirm(`确定要重置选中的 ${selectedIds.length} 个用户的密码吗？`, 'warning');
            if (!confirmed) return;
            
            try {
                const data = await apiCall('/api/users/bulk-reset-password', 'POST', { user_ids: selectedIds, new_password: 'test123' });
                
                // 显示成功消息，优先使用自定义消息，否则显示默认消息
                const successMsg = data.msg || `成功重置 ${data.data?.reset_count || selectedIds.length} 个用户的密码`;
                showMessage(successMsg, 'success');
                
                // 如果响应消息包含需要重新登录的提示，跳转到登录页面
                if (data.msg && data.msg.includes('需要重新登录')) {
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1000);
                } else {
                    // 立即刷新用户列表
                    loadUsers();
                }
            } catch (error) {
                showMessage(error.message || '密码重置失败', 'error');
            }
        }
        
        // 改变每页显示数量
        function changePageSize() {
            window.pageSize = parseInt(document.getElementById('page-size').value);
            window.currentPage = 1;
            loadUsers();
        }
        
        // 跳转到指定页码
        function jumpToPage() {
            const pageInput = document.getElementById('page-input');
            let page = parseInt(pageInput.value);
            
            if (isNaN(page) || page < 1) {
                page = 1;
            } else if (page > window.totalPages) {
                page = window.totalPages;
            }
            
            goToPage(page);
        }
        
        // 搜索用户
        function searchUsers() {
            const username = document.getElementById('username-search').value.trim();
            const name = document.getElementById('name-search').value.trim();
            const role = document.getElementById('role-search').value.trim();
            
            window.searchParams = {
                username: username,
                name: name,
                role: role
            };
            
            window.currentPage = 1;
            loadUsers();
        }
        
        // 将函数添加到全局作用域
        window.searchUsers = searchUsers;
        
        // 重置搜索
        function resetSearch() {
            document.getElementById('username-search').value = '';
            document.getElementById('name-search').value = '';
            document.getElementById('role-search').value = '';
            window.searchParams = {};
            window.currentPage = 1;
            loadUsers();
        }
        
        // 将函数添加到全局作用域
        window.resetSearch = resetSearch;
    </script>
</body>
</html>